## Installation
1. Run `composer require shawinigan/sso` to include this in your project.
2. Run `php artisan vendor:publish --provider="Shawinigan\Sso\LaravelAzureProvisioning\AzureProvisioningProvider"`.
3. Run `php artisan vendor:publish --provider="Shawinigan\Sso\LaravelAzureSocialite\AzureSocialiteProvider"`.
4. Run `npm install`
5. Run `npm run build`
6. Run `npm run dev`
7. Run `php artisan migrate`

## Configuration (Laravel)
1. Open `config/azureprovisioning.php` to adjust the packages configuration

    If the file doesn't exist, ensure you have ran `php artisan vendor:publish --provider="Shawinigan\Sso\LaravelAzureProvisioning\AzureProvisioningProvider"`.

2. Modify the configuration as required. All fields are commented and should provide enough description for how they change the way this package works.

3. If you do not wish to provision Groups you can entirely remove (or comment) the `Groups` key.

4. Open `config/shawi-sso.php` to adjust the packages configuration

4. ### Add configuration to `config/services.php`

```php
'azure' => [    
  'client_id' => env('AZURE_CLIENT_ID'),
  'client_secret' => env('AZURE_CLIENT_SECRET'),
  'redirect' => env('AZURE_REDIRECT_URI'),
  'tenant' => env('AZURE_TENANT_ID'),
  'proxy' => env('PROXY')  // optionally
],
```
5. ### Add provider event listener

Configure the package's listener to listen for `SocialiteWasCalled` events.

Add the event to your `listen[]` array in `app/Providers/EventServiceProvider`. See the [Base Installation Guide](https://socialiteproviders.com/usage/) for detailed instructions.

```php
protected $listen = [
    \SocialiteProviders\Manager\SocialiteWasCalled::class => [
        \Shawinigan\Sso\LaravelAzureSocialite\AzureExtendSocialite::class.'@handle',
    ],
];
```

## Configuration (Azure)
1. Login to Azure Active Directory
2. Select **All services** > **Enterprise applications**
3. Select **New application**
4. Select **Create your own application**
5. Provide your application's name and select the option _"Integrate any other application you don't find in the gallery (Non-gallery)"_

6. **A) To provision all users/groups**
    - On the properties page, ensure the option _"User assignment required?"_ is set to **No**

**--OR--**

6. **B) To provision select users/groups**
    - On the Properties page, ensure the option _"User assignment required?"_ is set to **Yes**
    - On the Users and groups page, add the users and groups that you wish to provision


7. Navigate to the Provisioning page
8. Set the Provisioning Mode to **Automatic**
9. In the Admin Credentials section set the Tenant URL to your domain (with https://) followed by `/scim/v2.0/` (Or the value you have set in in the `routePrefix` configuration option). (e.g. `https://laravel-azure-provisioning.com/scim/v2.0/`)
10. **TODO: Provide the secret token generated by ... ?**
11. Test the configuration and then save the settings
12. Expand the mapping section and remove any mappings that are not required by your application and add mappings that are missing and required by your application.
13. Save the settings again

**Note:** If you only want users within set groups to be provisioned, follow the steps in **6 B)** and add the groups you require. Only the members of the group will then be provisioned.


This repository is based on : 
https://github.com/RobTrehy/LaravelAzureProvisioning
https://github.com/SocialiteProviders/Microsoft-Azure